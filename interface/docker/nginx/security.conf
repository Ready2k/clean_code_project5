# Additional security configurations

# Hide nginx version
server_tokens off;

# Prevent clickjacking
add_header X-Frame-Options SAMEORIGIN always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options nosniff always;

# Enable XSS protection
add_header X-XSS-Protection "1; mode=block" always;

# Referrer policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions policy
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Block access to sensitive files
location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to version control directories
location ~ /\.(git|svn|hg|bzr) {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to backup files
location ~* \.(bak|backup|old|orig|save|swo|swp|tmp)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Limit request methods
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$ ) {
    return 405;
}

# Block suspicious user agents
if ($http_user_agent ~* (nmap|nikto|wikto|sf|sqlmap|bsqlbf|w3af|acunetix|havij|appscan)) {
    return 444;
}

# Block requests with no user agent
if ($http_user_agent = "") {
    return 444;
}

# Rate limiting for different endpoints
location /api/auth/login {
    limit_req zone=login burst=3 nodelay;
    limit_req_status 429;
}

location /api/auth/register {
    limit_req zone=login burst=2 nodelay;
    limit_req_status 429;
}

# Block common exploit attempts
location ~* (union.*select|insert.*into|delete.*from|drop.*table) {
    return 444;
}

# Block file injection attempts
location ~* \.(php|asp|aspx|jsp|cgi|pl)$ {
    return 444;
}